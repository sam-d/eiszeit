<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
 <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
<![endif]-->
<link rel="stylesheet" href="main.css" />
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>
<script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
<script src="js/geoPosition.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>

<div id="msg">
    <form>
        Breite: <input type="numeric" id="lat" name="lat" placeholder="latitude: 50.666" required >
        Länge: <input type="numeric" id="lon" name="lon" placeholder="longitude: 6.666" required >
        Radius: <input type="numeric" id="dist" name="dist" value="10" required> km
        <br/>
        <button type="button" id="geoButton">Finde mein Eis!</button>
    </form>
</div>
<div id="map"></div>
<aside id="sidepanel">
<button type="button" id="togglePane">&lt;</button>
<div id="pane-content"></div>
</aside>

<script type="text/javascript"> 
var positionObject = (function(){

    //default to Kölner Dom
    var latitude = 50.941277;
    var longitude = 6.958166;
    var hasRecentPosition = false;

    function hasLocalStorage(){
        try {
            return 'localStorage' in window && window['localStorage'] !== null;
        } catch (e) {
            return false;
        }
    }

    function getLocalStorage(){
        if(hasLocalStorage()){
            latitude = localStorage["lat"];
            longitude = localStorage["lon"];
        }
    }

    function setLocalStorage(){
        if(hasLocalStorage()){
            localStorage["lat"] = latitude;
            localStorage["lon"] = longitude;
        }
    }

    function noGeolocation(){
        $('#msg').toggle();
    }
    
    function geoSuccess(){
        latitude=p.coords.latitude;
        longitude=p.coords.longitude;
        hasRecentPosition = true;
        setLocalStorage();
        update('geo');
    }

    function geoLocate(){
        if (geoPosition.init()) {
            geoPosition.getCurrentPosition(geoSuccess, noGeolocation);
        }
    }

    function getPosition(){
        if(hasRecentPosition){
            console.log('here');
            return;
        }

        if(navigator.online !== undefined && !navigator.online){
            console.log('localS');
            getLocalStorage();
        }else{
            geoLocate();
            console.log('geo');
        }
    }

    return {
        lat:latitude, 
        lon:longitude,
        getPosition:getPosition
    };
})();

var iceMarker = (function(){

    var markerList = [];

    var icon = L.icon({
        iconUrl: 'icon.png',
        //shadowUrl: 'leaf-shadow.png',
        iconSize:     [48, 48], // size of the icon
        shadowSize:   [0, 0], // size of the shadow
        iconAnchor:   [24, 48], // point of the icon which will correspond to marker's location
        shadowAnchor: [24, 48],  // the same for the shadow
        popupAnchor:  [0, -48] // point from which the popup should open relative to the iconAnchor
    });

    function addMarker(lat,lon,name,props){
         markerList.push(L.marker([lat,lon],{icon:icon,data:props}).bindPopup(name).on('click',displayInfo));
    }

    function addAllMarker(data){
        if(data === undefined){
            return;
        }
        for(var i=0; i < data.results.length; i++){
            var obj = data.results[i];
            addMarker(obj.lat,obj.lon,obj.name,obj);
        }
    }

    function displayMarker(i){
        markerList[i].addTo(map);
    }

    function displayAllMarker(){
        for(var i=0; i< markerList.length; i++){
            displayMarker(i);
        }
    }

    function popMarker(i){
        markerList[i].openPopup();
    }

    function popAllMarker(){
        for(var i=0; i< markerList.length; i++){
            markerList[i].openPopup();
        }
    }

    function removeMarker(i){
        map.removeLayer(markerList[i]);
    }

    function removeAllMarker(){
        for(var i=0; i< markerList.length; i++){
            removeMarker(i);
        }
        markerList = [];
    }

    //not exported: click function
    function displayInfo(e){
        var info = e.target.options.data;
        $('#pane-content').html(info.format());
        $('#pane-content').toggle($('#pane-content').css('display') == "none");
    }

    return {
        displayMarker:displayMarker,
        displayAllMarker:displayAllMarker,
        removeMarker:removeMarker,  
        removeAllMarker:removeAllMarker,  
        popMarker:popMarker,  
        popAllMarker:popAllMarker,  
        addMarker: addMarker,
        addAllMarker: addAllMarker
    };

})();
function getData(lat, lon){
    //TODO better way to set data varible
    $.post("http://playground.sam-d.com/ice/query.php",{"lat":lat,"lon":lon,"dist":2},
            null,'json').done(function(data){
            for(var i=0; i < data.results.length; i++){
                data.results[i].format = function(){
                    var text =
                    "<h1>"+this.name+"</h1>"+"<h2>"+Number(this.distance).toFixed(4)+"</h2>";
                    return(text);
                    }
            }
            window.data=data;
            update("ajax");
            });
}

function update(from){
    //redraw map
    if(from === "geo"){
        map.setView([positionObject.lat, positionObject.lon], 13);
        userMarker.setLatLng([positionObject.lat, positionObject.lon]);
    }
    //ajax call
    if(from !== "ajax"){
        getData(positionObject.lat, positionObject.lon);
    }
    //update representation
    iceMarker.removeAllMarker();
    iceMarker.addAllMarker(data);
    iceMarker.displayAllMarker();
}
//get user position 
$('#geoButton').click(function(){
    
    positionObject.lat = $('#lat').val();
    positionObject.lon = $('#lon').val();

    update('geo');
    
    $('#msg').toggle();
});
positionObject.getPosition();

// create map
var map = L.map('map').setView([positionObject.lat, positionObject.lon], 13);
L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
var userMarker = L.marker([positionObject.lat, positionObject.lon]).addTo(map)
//get data from DB
var data = undefined;
getData(positionObject.lat, positionObject.lon);
</script>

</body>
</html>
