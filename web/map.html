<html>
<head>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
 <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
<![endif]-->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>
<script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
<script src="js/geoPosition.js" type="text/javascript" charset="utf-8"></script>
<style type="text/css">
#map { height: 400px; }
</style> 
</head>
<body>

<div id="map"></div>
<div id="msg"></div>

<script type="text/javascript"> 
var positionObject = (function(){

    //default to KÃ¶lner Dom
    var latitude = 50.941277;
    var longitude = 6.958166;
    var hasRecentPosition = false;

    function hasLocalStorage(){
        try {
            return 'localStorage' in window && window['localStorage'] !== null;
        } catch (e) {
            return false;
        }
    }

    function getLocalStorage(){
        if(hasLocalStorage()){
            latitude = localStorage["lat"];
            longitude = localStorage["lon"];
        }
    }

    function setLocalStorage(){
        if(hasLocalStorage()){
            localStorage["lat"] = latitude;
            localStorage["lon"] = longitude;
        }
    }

    function noGeolocation(){
        //TODO: ask user for its position
    }

    function geoLocate(){
        if (geoPosition.init()) {
            geoPosition.getCurrentPosition(function(p){latitude=p.coords.latitude;longitude=p.coords.longitude;hasRecentPosition = true;console.log('geo sucess'+p.coords.longitude+' '+p.coords.latitude);},
            noGeolocation);
            setLocalStorage();
        }
    }

    function getPosition(){
        if(hasRecentPosition){
            console.log('here');
            return;
        }

        if(navigator.online !== undefined && !navigator.online){
            console.log('localS');
            getLocalStorage();
        }else{
            geoLocate();
            console.log('geo');
            $('window').trigger('positionUpdate','geo')
        }
    }

    return {
        lat:latitude, 
        lon:longitude,
        getPosition:getPosition
    };
})();

function getData(lat, lon){
    $.post("http://playground.sam-d.com/ice/query.php",{"lat":lat,"lon":lon,"dist":2},
            null,'json').done(function(data){window.data=data;update("ajax");});
}

function update(from){
    //redraw map
    if(from === "geo"){
        map.setView([positionObject.lat, positionObject.lon], 13);
        userMarker.setLatLng([positionObject.lat, positionObject.lon]);
    }
    //ajax call
    if(from !== "ajax"){
        getData(positionObject.lat, positionObject.lon);
    }
    //update representation
    setIceMarker(data);
}
//get user position and bind event handler
positionObject.getPosition();
$('window').on('positionUpdate',update);


//define icon for marker
var popsicle = L.icon({
    iconUrl: 'icon.png',
    //shadowUrl: 'leaf-shadow.png',
    iconSize:     [48, 48], // size of the icon
    shadowSize:   [0, 0], // size of the shadow
    iconAnchor:   [24, 48], // point of the icon which will correspond to marker's location
    shadowAnchor: [24, 48],  // the same for the shadow
    popupAnchor:  [0, -48] // point from which the popup should open relative to the iconAnchor
});
// create map
var map = L.map('map').setView([positionObject.lat, positionObject.lon], 13);
L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
var userMarker = L.marker([positionObject.lat, positionObject.lon]).addTo(map)
//get data from DB
var data = undefined;
getData(positionObject.lat, positionObject.lon);

function setIceMarker(data){
    if(data === undefined){
        return;
    }
    for(var i=0; i < data.results.length; i++){
        var obj = data.results[i];
        var mark = L.marker([obj.lat,obj.lon],{icon:popsicle}).addTo(map).bindPopup(obj.name);
        if( i == 0){
            mark.openPopup();
        }
    }
}

//set markers at targets
setIceMarker(data);
</script>

</body>
</html>
